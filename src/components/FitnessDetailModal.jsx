import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import supabase from '../supabaseClient';
import './FitnessDetailModal.css';

const FitnessDetailModal = (props) => {
  const { 
    isOpen, 
    onClose, 
    fitnessData,
    onViewLocation,
    onOpenImageGallery,
    isFullPage = false, // ‡πÄ‡∏û‡∏¥‡πà‡∏° prop ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    user = null // ‡∏£‡∏±‡∏ö user ‡∏à‡∏≤‡∏Å props ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  } = props;

  // DEBUG: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ user ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
  console.log('FitnessDetailModal user:', user);
  const isLoggedIn = !!user?.id;
  console.log('FitnessDetailModal isLoggedIn:', isLoggedIn);

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [loginModalMessage, setLoginModalMessage] = useState('');
  const navigate = useNavigate();
  const [shareNotification, setShareNotification] = useState('');
  const [selectedDate, setSelectedDate] = useState('');
  const [isBookingMode, setIsBookingMode] = useState(false);
  const [equipmentData, setEquipmentData] = useState([]);
  const [ownerData, setOwnerData] = useState(null);
  const [moreDetailsData, setMoreDetailsData] = useState([]);
  const [isMembershipBookingMode, setIsMembershipBookingMode] = useState({
    monthly: false,
    yearly: false
  });
  const [membershipStartDate, setMembershipStartDate] = useState({
    monthly: '',
    yearly: ''
  });
  const [promotions, setPromotions] = useState([]);
  const [selectedPromotion, setSelectedPromotion] = useState(null);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
  useEffect(() => {
    const loadAdditionalData = async () => {
      // Determine fitness id from several possible fields used across the codebase
      const fitId = fitnessData?.fit_id || fitnessData?.id || fitnessData?.fitness_id || fitnessData?.fitId || fitnessData?.partner_fitness_id;
      console.log('FitnessDetailModal loadAdditionalData - fitnessData:', fitnessData);
      console.log('FitnessDetailModal determined fitId:', fitId);
      if (!fitId) {
        console.warn('No fitId available for this fitnessData, skipping equipment/promotions load');
        return;
      }
      
      try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        // Try different column names to find equipment rows related to this fitness
        const equipmentColumnsToTry = ['fitness_id', 'fit_id', 'partner_fitness_id', 'fitnessId'];
        let equipment = null;
        let equipmentError = null;
        for (const col of equipmentColumnsToTry) {
          try {
            const res = await supabase.from('tbl_equipment').select('*').eq(col, fitId).order('em_id', { ascending: true });
            // res may be { data, error }
            const data = res.data || res;
            const error = res.error || null;
            console.log(`Tried equipment column ${col} -> data length:`, (data && data.length) || 0, ' error:', error);
            if (!error && data && data.length > 0) {
              equipment = data;
              equipmentError = null;
              break;
            }
            // if no error but empty result, keep trying other columns
            equipmentError = error;
          } catch (err) {
            console.error('Exception while querying equipment with column', col, err);
            equipmentError = err;
          }
        }

        if (equipmentError && equipmentError.code !== 'PGRST116') {
          console.error('Error loading equipment (after tries):', equipmentError);
        }
        setEquipmentData(equipment || []);

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
        const { data: owner, error: ownerError } = await supabase
          .from('tbl_owner')
          .select('*')
          .eq('owner_name', fitnessData.fit_user)
          .single();

        if (ownerError && ownerError.code !== 'PGRST116') {
          console.error('Error loading owner:', ownerError);
        } else {
          setOwnerData(owner);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å field fit_moredetails
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å field fit_moredetails ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á tbl_fitness
        const moreDetailsText = fitnessData.fit_moredetails || '';
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        let processedMoreDetails = [];
        if (moreDetailsText && moreDetailsText.trim()) {
          // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏° newline ‡∏´‡∏£‡∏∑‡∏≠ bullet points
          const lines = moreDetailsText.split(/\n|‚Ä¢|‚ó¶|-/).filter(line => line.trim());
          processedMoreDetails = lines.map((line, index) => ({
            id: index + 1,
            title: line.trim(),
            description: '',
            type: 'text'
          }));
        }
        
        // Debug logging disabled for clean console  
        setMoreDetailsData(processedMoreDetails);

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™‡∏ô‡∏µ‡πâ (active)
        try {
          // Promotions: try different column names and be tolerant to missing 'status' column
          const promoColumnsToTry = ['fit_id', 'fitness_id', 'partner_fitness_id', 'fitnessId'];
          let promoData = null;
          let promoError = null;

          for (const col of promoColumnsToTry) {
            try {
              // First try with status='active' if that column exists; if it fails, fall back to no status
              let res = await supabase.from('tbl_promotions').select('*').eq(col, fitId).order('created_at', { ascending: false });
              let data = res.data || res;
              let error = res.error || null;
              console.log(`Tried promotions column ${col} -> data length:`, (data && data.length) || 0, ' error:', error);
              if (error) {
                // try again without other filters (already no filters besides eq)
                promoError = error;
                continue;
              }
              // Accept empty arrays too (no promotions), but keep the returned value
              promoData = data || [];
              promoError = null;
              break;
            } catch (err) {
              console.error('Exception while querying promotions with column', col, err);
              promoError = err;
            }
          }

          if (promoError) {
            console.error('Error loading promotions (after tries):', promoError);
          }

          // Filter by date range in JS (if start/end present)
          if (promoData) {
            const now = new Date();
            const filtered = (promoData || []).filter(p => {
              if (!p.start_date && !p.end_date) return true;
              const start = p.start_date ? new Date(p.start_date) : null;
              const end = p.end_date ? new Date(p.end_date) : null;
              if (start && now < start) return false;
              if (end && now > end) return false;
              return true;
            });
            setPromotions(filtered);
          } else {
            setPromotions([]);
          }
        } catch (err) {
          console.error('Error fetching promotions:', err);
        }

      } catch (error) {
        console.error('Error loading additional data:', error);
      }
    };

    loadAdditionalData();
  }, [fitnessData?.fit_id, fitnessData?.fit_user, fitnessData?.fit_moredetails]);

  if (!isOpen || !fitnessData) return null;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ - ‡∏ï‡∏±‡∏î .00 ‡∏≠‡∏≠‡∏Å
  const formatTime = (timeString) => {
    if (!timeString) return timeString;
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
    return timeString
      .replace(/(\d+):00\.00/g, '$1:00')     // 10:00.00 -> 10:00
      .replace(/(\d+)\.00\.00/g, '$1.00')   // 10.00.00 -> 10.00  
      .replace(/(\d+)\.00$/g, '$1')         // 10.00 -> 10
      .replace(/(\d+):00:00/g, '$1:00')     // 10:00:00 -> 10:00
      .replace(/\.00\s*-\s*(\d+)\.00/g, ' - $1')  // 10.00 - 23.00 -> 10 - 23
      .replace(/(\d+)\.00/g, '$1');         // ‡∏ï‡∏±‡∏î .00 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™
  const handleShare = async () => {
    const shareData = {
      title: `${fitnessData.fit_name || fitnessData.name} - PJ Fitness`,
      text: `üèãÔ∏è‚Äç‚ôÇÔ∏è ${fitnessData.fit_name || fitnessData.name}\nüìç ${fitnessData.fit_address || fitnessData.location}\nüí∞ ${fitnessData.fit_price || fitnessData.price || 60} ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô\n‚≠ê ${fitnessData.rating || '4.5'} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`,
      url: window.location.href
    };

    try {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Share API ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (navigator.share) {
        await navigator.share(shareData);
        setShareNotification('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏ó‡∏ô
        await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
        setShareNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
      }
    } catch (error) {
      console.error('Error sharing:', error);
      // ‡∏ñ‡πâ‡∏≤ error ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢
      try {
        await navigator.clipboard.writeText(window.location.href);
        setShareNotification('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
      } catch (clipboardError) {
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á prompt
        prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ô‡∏µ‡πâ:', window.location.href);
        setShareNotification('üìã ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á');
      }
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setTimeout(() => {
      setShareNotification('');
    }, 3000);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  const handleBookingClick = () => {
  console.log('handleBookingClick - user:', user, 'isLoggedIn:', isLoggedIn);
    setIsBookingMode(!isBookingMode);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  const handleConfirmBooking = () => {
    try {
  console.log('handleConfirmBooking - user:', user, 'isLoggedIn:', isLoggedIn);
      if (!selectedDate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
        return;
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      const bookingData = {
        fitness_id: fitnessData?.fit_id || 22,
        fitnessName: fitnessData?.fit_name || fitnessData?.name || 'JM FITNESS',
        owner_uid: fitnessData?.owner_uid || 1,
        booking_date: selectedDate,
        total_amount: fitnessData?.fit_price || fitnessData?.price || 60,
        location: fitnessData?.fit_location || fitnessData?.location || '‡∏Ç‡∏≤‡∏ß‡πÄ‡∏ô‡∏µ‡∏¢‡∏á ‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°',
        rating: fitnessData?.rating || '4.5',
        contact: fitnessData?.fit_contact || fitnessData?.contact,
        phone: fitnessData?.fit_phone || fitnessData?.phone,
        owner_name: fitnessData?.fit_user || ownerData?.owner_name,
        description: fitnessData?.fit_description || fitnessData?.description,
        images: {
          main: fitnessData?.fit_image || fitnessData?.image,
          secondary: [fitnessData?.fit_image2, fitnessData?.fit_image3, fitnessData?.fit_image4].filter(Boolean)
        },
        booking_type: 'daily' // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
      };
      
      
      // Navigate ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      navigate('/payment', { 
        state: { bookingData } 
      });
      
    } catch (error) {
      console.error('Error in handleConfirmBooking:', error);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    }
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  const handleCancelBooking = () => {
    setIsBookingMode(false);
    setSelectedDate('');
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°
  const handleMembershipBookingWithDate = (membershipType, amount, startDate) => {
    try {
      if (!startDate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
        return;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      const membershipData = {
        fitness_id: fitnessData?.fit_id || 22,
        fitnessName: fitnessData?.fit_name || fitnessData?.name || 'JM FITNESS',
        owner_uid: fitnessData?.owner_uid || 1,
        membership_type: membershipType, // 'monthly' ‡∏´‡∏£‡∏∑‡∏≠ 'yearly'
        total_amount: amount,
        start_date: startDate, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        location: fitnessData?.fit_location || fitnessData?.location || '‡∏Ç‡∏≤‡∏ß‡πÄ‡∏ô‡∏µ‡∏¢‡∏á ‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°',
        rating: fitnessData?.rating || '4.5',
        contact: fitnessData?.fit_contact || fitnessData?.contact,
        phone: fitnessData?.fit_phone || fitnessData?.phone,
        owner_name: fitnessData?.fit_user || ownerData?.owner_name,
        description: fitnessData?.fit_description || fitnessData?.description,
        images: {
          main: fitnessData?.fit_image || fitnessData?.image,
          secondary: [fitnessData?.fit_image2, fitnessData?.fit_image3, fitnessData?.fit_image4].filter(Boolean)
        },
        booking_type: 'membership' // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      };
      
      // Navigate ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      navigate('/payment', { 
        state: { bookingData: membershipData } 
      });
      
    } catch (error) {
      console.error('Error in handleMembershipBookingWithDate:', error);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    }
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
  const getTodayDate = () => {
    const today = new Date();
    return today.toISOString().split('T')[0];
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)
  const getMaxDate = () => {
    const maxDate = new Date();
    maxDate.setDate(maxDate.getDate() + 30);
    return maxDate.toISOString().split('T')[0];
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  const handleClaimPromotion = (promo) => {
    try {
      if (!isLoggedIn) {
        setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô');
        setShowLoginModal(true);
        return;
      }

      const bookingData = {
        fitness_id: fitnessData?.fit_id || fitnessData?.id,
        fitnessName: fitnessData?.fit_name || fitnessData?.name || 'JM FITNESS',
        owner_uid: fitnessData?.owner_uid || 1,
        booking_date: getTodayDate(),
        total_amount: fitnessData?.fit_price || fitnessData?.price || 60,
        location: fitnessData?.fit_location || fitnessData?.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',
        rating: fitnessData?.rating || '4.5',
        contact: fitnessData?.fit_contact || fitnessData?.contact,
        phone: fitnessData?.fit_phone || fitnessData?.phone,
        owner_name: fitnessData?.fit_user || ownerData?.owner_name,
        description: fitnessData?.fit_description || fitnessData?.description,
        images: {
          main: fitnessData?.fit_image || fitnessData?.image,
          secondary: [fitnessData?.fit_image2, fitnessData?.fit_image3, fitnessData?.fit_image4].filter(Boolean)
        },
        booking_type: 'promotion',
        promotion: promo
      };

      setSelectedPromotion(promo);
      navigate('/payment', { state: { bookingData } });
    } catch (err) {
      console.error('Error claiming promotion:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô');
    }
  };



  // Debug logs
  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Full Page ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ layout ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
  if (isFullPage) {
    return (
      <div className="fitness-detail-content">
        {/* Share Notification */}
        {shareNotification && (
          <div className="share-notification">
            {shareNotification}
          </div>
        )}
        
        {/* Header Section */}
        <div className="fitness-header">
          <div className="fitness-title-section">
            <h1 className="fitness-title">{fitnessData.fit_name || fitnessData.name}</h1>
            <div className="fitness-location">
              üìç {fitnessData.fit_address || fitnessData.location}
            </div>
            <div className="fitness-owner">
              üë§ ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: {fitnessData.fit_user || ownerData?.owner_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á'}
            </div>
          </div>
          <div className="fitness-actions">
            <button className="favorite-btn" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î">‚ù§Ô∏è</button>
            <button className="share-btn" onClick={handleShare} title="‡πÅ‡∏ä‡∏£‡πå‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™">üì§</button>
          </div>
        </div>

        {/* Main Content */}
        <div className="fitness-main-content">
          {/* Left Section - Images */}
          <div className="fitness-images-section">
            <div className="main-image-container">
              <img 
                src={fitnessData.fit_image || fitnessData.image || "data:image/svg+xml,%3Csvg width='400' height='300' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%' height='100%' fill='%23f0f0f0'/%3E%3Ctext x='50%' y='50%' font-size='18' fill='%23666' text-anchor='middle' dy='.3em'%3EGym Image%3C/text%3E%3C/svg%3E"}
                alt={fitnessData.fit_name || fitnessData.name}
                className="main-fitness-image"
                onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, 0)}
              />
            </div>
            
            {/* Thumbnail Images */}
            <div className="thumbnail-images">
              {[fitnessData.fit_image2, fitnessData.fit_image3, fitnessData.fit_image4].map((img, index) => 
                img && (
                  <img 
                    key={index}
                    src={img} 
                    alt={`‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡∏¥‡∏° ${index + 1}`} 
                    className="thumbnail-image"
                    onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, index + 1)}
                  />
                )
              )}
            </div>

            {/* Equipment Section */}
            <div className="equipment-showcase">
              <h3>üèãÔ∏è‚Äç‚ôÇÔ∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
              <div className="equipment-grid-showcase">
                {equipmentData.length > 0 ? (
                  equipmentData.slice(0, 6).map((equipment, index) => (
                      <div key={equipment.em_id || index} className="equipment-showcase-item">
                        <div className="equipment-image-container">
                          {equipment.em_image ? (
                            <img 
                              src={equipment.em_image} 
                              alt={equipment.em_name}
                              className="equipment-showcase-image"
                              onError={(e) => {
                                if (e.target) e.target.style.display = 'none';
                                if (e.target && e.target.nextSibling) e.target.nextSibling.style.display = 'flex';
                              }}
                            />
                          ) : (
                            <div className="equipment-placeholder">
                              üèãÔ∏è
                            </div>
                          )}
                        </div>
                        <div className="equipment-showcase-info">
                          <h4>{equipment.em_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                          {/* <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {equipment.em_qty || 1} ‡∏ä‡∏¥‡πâ‡∏ô</p> */}
                          {equipment.em_detail && (
                            <p className="equipment-detail">{equipment.em_detail}</p>
                          )}
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="no-equipment">
                      <p>üöß ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
                    </div>
                  )}
                </div>
            </div>

            {/* More Details Section */}
            <div className="more-details-section">
              <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
              
              {/* Debug Info removed for clean UI */}
              
              {moreDetailsData && moreDetailsData.length > 0 ? (
                <div className="more-details-list">
                  {moreDetailsData.map((detail, index) => (
                    <div key={index} className="more-detail-item">
                      <div className="detail-bullet">‚Ä¢</div>
                      <div className="detail-text">{detail.title}</div>
                    </div>
                  ))}
                </div>
              ) : fitnessData?.fit_moredetails && fitnessData.fit_moredetails.trim() ? (
                <div className="direct-more-details">
                  <div className="detail-content">
                    <pre className="detail-text-raw">{fitnessData.fit_moredetails}</pre>
                  </div>
                </div>
              ) : (
                <div className="no-more-details">
                  <p>üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
                </div>
              )}
            </div>
          </div>

          {/* Description Section */}
              {(fitnessData.fit_description || fitnessData.description) && (
                <div className="description-section">
                  <h4>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                  <p>{fitnessData.fit_description || fitnessData.description}</p>
                </div>
              )}

          {/* Right Section - Info & Booking */}
          <div className="fitness-info-sidebar">
            {/* Rating & Price */}
            <div className="rating-price-section">
              <div className="rating-display">
                <span className="rating-score">{fitnessData.rating || '4.5'}</span>
                <div className="rating-details">
                  <div className="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                  <div className="rating-count">100 ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>
                </div>
              </div>
            </div>

            {/* Information Cards */}
            <div className="info-cards">
              <div className="info-card">
                <div className="info-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</div>
              </div>
              <div className="info-card">
                <div className="info-label">‡∏û‡∏≠‡πÉ‡∏à‡∏•‡∏∞‡∏ï‡∏¥‡πÄ‡∏ã‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</div>
              </div>
              <div className="info-card">
                <div className="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
              </div>
            </div>

            {/* Map Section */}
            <div className="map-section">
              <div className="map-placeholder">
                <button className="map-btn" onClick={() => onViewLocation && onViewLocation(fitnessData)}>
                  üìç ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
                </button>
              </div>
            </div>
            
            {/* Promotions Section (below map) */}
            <div className="promotions-section">
              <h4>üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h4>
              {promotions && promotions.length > 0 ? (
                <div className="promotions-list">
                  {promotions.map((p) => (
                    <div key={p.promo_id || p.id} className="promotion-item">
                      <div className="promo-info">
                        <div className="promo-title">{p.title || p.promo_name || '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô'}</div>
                        {p.description && <div className="promo-desc">{p.description}</div>}
                        {p.discount_amount && <div className="promo-discount">‡∏•‡∏î {p.discount_amount} ‡∏ö‡∏≤‡∏ó</div>}
                        {p.discount_percent && <div className="promo-discount">‡∏•‡∏î {p.discount_percent}%</div>}
                        {p.start_date && <div className="promo-dates">‡πÄ‡∏£‡∏¥‡πà‡∏°: {new Date(p.start_date).toLocaleDateString()}</div>}
                        {p.end_date && <div className="promo-dates">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: {new Date(p.end_date).toLocaleDateString()}</div>}
                      </div>
                      <div className="promo-action">
                        <button className="claim-promo-btn" onClick={() => handleClaimPromotion(p)}>‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="no-promotions">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
              )}
            </div>
            

            {/* Schedule & Booking */}
            <div className="schedule-booking">
              <div className="schedule-info">
                
                <div className="schedule-item">
                  <span className="schedule-label">‡πÄ‡∏ß‡∏•‡∏≤:</span>
                  <span className="schedule-value">
                    {fitnessData.fit_open_time && fitnessData.fit_close_time 
                      ? `${formatTime(fitnessData.fit_open_time)} - ${formatTime(fitnessData.fit_close_time)}`
                      : formatTime(fitnessData.hours) || '08.00 - 22.00'
                    }
                  </span>
                </div>
              </div>
              
              {/* Daily Booking Button */}
              {!isBookingMode ? (
                <button
                  className="membership-btn daily"
                  onClick={isLoggedIn ? handleBookingClick : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'); setShowLoginModal(true); }}
                >
                  <span className="membership-price">{fitnessData.fit_price || fitnessData.price || 69}</span>
                  <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô</span>
                  <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                </button>
              ) : (
                <button 
                  className="membership-btn daily selected" 
                  onClick={handleBookingClick}
                >
                  <span className="membership-price">{fitnessData.fit_price || fitnessData.price || 69}</span>
                  <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô</span>
                  <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                </button>
              )}

              {/* Booking Section */}
              {isBookingMode && (
                <div className="booking-form">
                  <div className="date-selection">
                    <label htmlFor="booking-date">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input
                      type="date"
                      id="booking-date"
                      value={selectedDate}
                      onChange={(e) => setSelectedDate(e.target.value)}
                      min={getTodayDate()}
                      max={getMaxDate()}
                      className="date-input"
                    />
                  </div>
                  <div className="booking-actions">
                    <button
                      className="confirm-booking-btn"
                      onClick={isLoggedIn ? handleConfirmBooking : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'); setShowLoginModal(true); }}
                    >
                      ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                    </button>
                    <button className="cancel-booking-btn" onClick={handleCancelBooking}>
                      ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                  </div>
                </div>
              )}

              

              {/* Membership Prices */}
              {(fitnessData.fit_price_memberm || fitnessData.priceMonthly) && (
                <div className="membership-container">
                  {!isMembershipBookingMode.monthly ? (
                    <button
                      className="membership-btn monthly"
                      onClick={isLoggedIn ? () => setIsMembershipBookingMode({...isMembershipBookingMode, monthly: true}) : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'); setShowLoginModal(true); }}
                    >
                      <span className="membership-price">{fitnessData.fit_price_memberm || fitnessData.priceMonthly}</span>
                      <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)</span>
                      <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </button>
                  ) : (
                    <div className="membership-booking-form">
                      <button className="membership-btn monthly selected">
                        <span className="membership-price">{fitnessData.fit_price_memberm || fitnessData.priceMonthly}</span>
                        <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)</span>
                        <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                      </button>
                      <div className="membership-date-selection">
                        <label htmlFor="membership-start-date-monthly">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</label>
                        <input
                          type="date"
                          id="membership-start-date-monthly"
                          value={membershipStartDate.monthly}
                          onChange={(e) => setMembershipStartDate({...membershipStartDate, monthly: e.target.value})}
                          min={getTodayDate()}
                          max={getMaxDate()}
                          className="date-input"
                        />
                      </div>
                      <div className="membership-actions">
                        <button
                          className="confirm-membership-btn"
                          onClick={isLoggedIn ? () => handleMembershipBookingWithDate('monthly', fitnessData.fit_price_memberm || fitnessData.priceMonthly, membershipStartDate.monthly) : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'); setShowLoginModal(true); }}
                        >
                          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                        </button>
                        <button 
                          className="cancel-membership-btn" 
                          onClick={() => {
                            setIsMembershipBookingMode({...isMembershipBookingMode, monthly: false});
                            setMembershipStartDate({...membershipStartDate, monthly: ''});
                          }}
                        >
                          ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              {(fitnessData.fit_price_membery || fitnessData.priceYearly) && (
                <div className="membership-container">
                  {!isMembershipBookingMode.yearly ? (
                    <button
                      className="membership-btn yearly"
                      onClick={isLoggedIn ? () => setIsMembershipBookingMode({...isMembershipBookingMode, yearly: true}) : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ'); setShowLoginModal(true); }}
                    >
                      <span className="membership-price">{fitnessData.fit_price_membery || fitnessData.priceYearly}</span>
                      <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)</span>
                      <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</span>
                    </button>
                  ) : (
                    <div className="membership-booking-form">
                      <button className="membership-btn yearly selected">
                        <span className="membership-price">{fitnessData.fit_price_membery || fitnessData.priceYearly}</span>
                        <span className="membership-unit">‡∏ö‡∏≤‡∏ó/‡∏õ‡∏µ (‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)</span>
                        <span className="membership-action"> ‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</span>
                      </button>
                      <div className="membership-date-selection">
                        <label htmlFor="membership-start-date-yearly">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</label>
                        <input
                          type="date"
                          id="membership-start-date-yearly"
                          value={membershipStartDate.yearly}
                          onChange={(e) => setMembershipStartDate({...membershipStartDate, yearly: e.target.value})}
                          min={getTodayDate()}
                          max={getMaxDate()}
                          className="date-input"
                        />
                      </div>
                      <div className="membership-actions">
                        <button
                          className="confirm-membership-btn"
                          onClick={isLoggedIn ? () => handleMembershipBookingWithDate('yearly', fitnessData.fit_price_membery || fitnessData.priceYearly, membershipStartDate.yearly) : () => { setLoginModalMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ'); setShowLoginModal(true); }}
                        >
                          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                        </button>
                        <button 
                          className="cancel-membership-btn" 
                          onClick={() => {
                            setIsMembershipBookingMode({...isMembershipBookingMode, yearly: false});
                            setMembershipStartDate({...membershipStartDate, yearly: ''});
                          }}
                        >
                          ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
              

              
            </div>

            {/* Contact Info */}
            <div className="contact-section">
              <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4>
              
              <div className="contact-item">
                <span className="contact-icon">üìû</span>
                <span className="contact-text">{fitnessData.fit_phone || fitnessData.phone || ownerData?.owner_phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'}</span>
              </div>
              {(fitnessData.fit_contact || fitnessData.contact) && (
                <div className="contact-item">
                  <span className="contact-icon">‚úâÔ∏è</span>
                  <span className="contact-text">{fitnessData.fit_contact || fitnessData.contact}</span>
                </div>
              )}
              {ownerData?.owner_email && (
                <div className="contact-item">
                  <span className="contact-icon">üìß</span>
                  <span className="contact-text">{ownerData.owner_email}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Login Required Modal */}
        {showLoginModal && (
          <div className="modal-overlay" onClick={() => setShowLoginModal(false)}>
            <div className="login-required-modal" onClick={e => e.stopPropagation()}>
              <div className="modal-header">
                <h3>üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <button className="close-btn" onClick={() => setShowLoginModal(false)}>√ó</button>
              </div>
              <div className="modal-body">
                <p>{loginModalMessage}</p>
                <div className="modal-actions">
                  <button
                    className="login-btn-modal"
                    onClick={() => {
                      setShowLoginModal(false);
                      window.location.href = '/login';
                    }}
                  >
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                  <button
                    className="register-btn-modal"
                    onClick={() => {
                      setShowLoginModal(false);
                      window.location.href = '/register';
                    }}
                  >
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // Original Modal Layout (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
  return (
    <>
      <div className={`detail-modal-overlay ${isFullPage ? 'fitness-detail-page' : ''}`} onClick={isFullPage ? undefined : onClose}>
        <div className="detail-modal-content" onClick={(e) => e.stopPropagation()}>
          <div className="modal-header">
            <h2>{fitnessData.fitness_name}</h2>
            <button className="close-btn" onClick={onClose}>√ó</button>
          </div>
          
          <div className="modal-body">
            <div className="fitness-detail-container">
              {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */}
              <div className="fitness-image-section">
                <div className="main-image-container">
                  <img 
                    src={fitnessData.image || "data:image/svg+xml,%3Csvg width='400' height='300' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%' height='100%' fill='%23f0f0f0'/%3E%3Ctext x='50%' y='50%' font-size='18' fill='%23666' text-anchor='middle' dy='.3em'%3EGym Image%3C/text%3E%3C/svg%3E"}
                    alt={fitnessData.fitness_name}
                    className="detail-main-image"
                    onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, 0)}
                    style={{ cursor: 'pointer' }}
                    onError={(e) => {
                      e.target.src = "data:image/svg+xml,%3Csvg width='400' height='300' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%' height='100%' fill='%23f0f0f0'/%3E%3Ctext x='50%' y='50%' font-size='18' fill='%23666' text-anchor='middle' dy='.3em'%3EGym Image%3C/text%3E%3C/svg%3E";
                    }}
                  />
                </div>
                
                {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏£‡∏¥‡∏° */}
                {(fitnessData.fit_image2 || fitnessData.fit_image3 || fitnessData.fit_image4) && (
                  <div className="additional-images">
                    <h4>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                    <div className="additional-images-grid">
                      {fitnessData.fit_image2 && (
                        <img 
                          src={fitnessData.fit_image2} 
                          alt="‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡∏¥‡∏° 1" 
                          className="detail-additional-image"
                          onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, 1)}
                        />
                      )}
                      {fitnessData.fit_image3 && (
                        <img 
                          src={fitnessData.fit_image3} 
                          alt="‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡∏¥‡∏° 2" 
                          className="detail-additional-image"
                          onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, 2)}
                        />
                      )}
                      {fitnessData.fit_image4 && (
                        <img 
                          src={fitnessData.fit_image4} 
                          alt="‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡∏¥‡∏° 3" 
                          className="detail-additional-image"
                          onClick={() => onOpenImageGallery && onOpenImageGallery(fitnessData, 3)}
                        />
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

    </>
      
  );
};

export default FitnessDetailModal;